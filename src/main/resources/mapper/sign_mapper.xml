<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC   "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd"
>
<mapper namespace="com.frans.sign.dao.SignDAO">

	<select id="signList" resultType="signDTO">
		SELECT s.sign_idx , s.sign_title, e.emp_name, s.sign_date, ss.sign_state_type
			FROM sign s, sign_state ss, employee e
			WHERE s.emp_id = e.emp_id AND s.sign_state_idx = ss.sign_state_idx AND s.sign_date BETWEEN DATE_ADD(NOW(), INTERVAL -2 WEEK ) AND NOW()
			ORDER BY sign_idx
	</select>
	
	<select id="dateSearch" resultType="signDTO">
		SELECT s.sign_idx , s.sign_title, e.emp_name, s.sign_date, ss.sign_state_type
			FROM sign s, sign_state ss, employee e
			WHERE s.emp_id = e.emp_id AND s.sign_state_idx = ss.sign_state_idx AND s.sign_date BETWEEN #{param1} AND #{param2} ORDER BY sign_idx
	</select>
	
	<select id="signWriteGo" resultType="DocFormDTO">
		SELECT df.doc_form_idx, df.doc_form_content, dt.doc_type_name, dt.doc_type_idx FROM doc_form df, document_type dt
			WHERE df.doc_type_idx = dt.doc_type_idx AND doc_form_idx = #{param1};
	</select>
	
	<select id="memberList" resultType="com.frans.member.dto.MemberDTO">
		SELECT e.emp_id, e.emp_name, t.team_name, p.pos_name FROM employee e, team t, position p
			WHERE e.team_idx = t.team_idx AND e.pos_idx = p.pos_idx;
	</select>
	
	<insert id="signWriteDo"
			useGeneratedKeys="true"
			keyColumn="sign_idx"
			keyProperty="sign_idx"
			parameterType="signDTO">
			INSERT INTO sign(emp_id, doc_type_idx, sign_content, sign_title, sign_team_open)
				VALUES (#{emp_id}, #{doc_type_idx}, #{sign_content},#{sign_title},
			<if test="sign_team_open.equals('공개')">'공개')</if>
			<if test="sign_team_open.equals('비공개')">'비공개')</if>
	</insert>
	
 	<insert id="signMember"
 			useGeneratedKeys="true"
			keyColumn="emp_id"
			keyProperty="emp_id"
			parameterType="signMemDTO">
			INSERT INTO sign_mem(emp_id, sign_idx, sign_mem_order, sign_mem_ip)
				VALUES(#{emp_id}, #{sign_idx}, #{sign_mem_order}, '127.0.0.1')
	</insert> 
	
	<insert id="refMember"
			useGeneratedKeys="true"
			keyColumn="emp_id"
			keyProperty="emp_id"
			parameterType="ReferDTO">
		INSERT INTO reference(emp_id, sign_idx) VALUES(#{emp_id}, #{sign_idx})
	</insert>
	
	<update id="docForm_use_update">
		UPDATE doc_form SET doc_form_use = doc_form_use +1 WHERE doc_form_idx = #{param1} 
	</update>
	
	<insert id="fileUpload">
		INSERT INTO file(file_sort_idx, file_from, file_ori, file_new) VALUES('3', #{param1}, #{param2}, #{param3})
	</insert>
	
	<select id="fileList" parameterType="String" resultType="String">
		SELECT file_new FROM file WHERE file_sort_idx = 3 AND file_from = #{param1} ORDER BY file_idx
	</select>
	
	<select id="orifileList" parameterType="String" resultType="String">
		SELECT file_ori FROM file WHERE file_sort_idx = 3 AND file_from = #{param1} ORDER BY file_idx
	</select>

	<select id="signDetailGo" resultType="signDTO">
		SELECT s.sign_idx, dt.doc_type_name, s.sign_team_open, s.emp_id, t.team_name, s.sign_title, s.sign_content, e.emp_name, e.emp_admin_auth, ss.sign_state_type 
			FROM sign s, employee e, document_type dt, team t, sign_state ss
			WHERE s.emp_id = e.emp_id AND e.team_idx = t.team_idx AND s.doc_type_idx = dt.doc_type_idx AND s.sign_state_idx = ss.sign_state_idx AND s.sign_idx=#{param1}
	</select>
	
 	<select id="signDetailSignmem" resultType="hashmap">
		SELECT s.sign_idx, sm.emp_id, e.emp_name, sm.sign_mem_order, sm.sign_mem_comment, sm.sign_mem_state FROM sign s, sign_mem sm, employee e 
			WHERE s.sign_idx = sm.sign_idx AND sm.emp_id = e.emp_id AND sm.sign_idx=#{param1}
	</select>
	
	<select id="signDetailRefermem" resultType="hashmap">
		SELECT s.sign_idx, r.emp_id, e.emp_name FROM sign s, reference r, employee e 
			WHERE s.sign_idx = r.sign_idx AND r.emp_id = e.emp_id AND r.sign_idx=#{param1}
	</select>
	
	<select id="selectEmpName" resultType="com.frans.member.dto.MemberDTO">
		SELECT e.emp_name, t.team_name FROM employee e, team t WHERE e.team_idx = t.team_idx AND e.emp_id = #{param1}
	</select>
	
	<select id="loginName" resultType="String">
		SELECT emp_name FROM employee WHERE emp_id = #{param1}
	</select>
	
	<select id="signHistory" resultType="SignHistoryDTO">
		SELECT e.emp_name, s.sign_idx, sm.emp_id, sm.sign_mem_ip, p.pos_name, sm.sign_mem_time, sm.sign_mem_state
			FROM sign s, sign_mem sm, sign_state ss, employee e, `position` p
			WHERE e.emp_id = sm.emp_id AND s.sign_idx = sm.sign_idx AND e.pos_idx = p.pos_idx AND s.sign_state_idx = ss.sign_state_idx AND s.sign_idx = #{param1}
	</select>
	
	<select id="lastOrder" resultType="String">
		SELECT emp_id FROM sign_mem
			WHERE sign_mem_order = (SELECT (SELECT count(emp_id) FROM sign_mem sm WHERE sign_idx=s.sign_idx) FROM sign s WHERE s.sign_idx = #{param1}) AND sign_idx = #{param1}
	</select>
	
	<update id="signMemUpdate">
		UPDATE sign_mem set sign_mem_comment = #{param4}, sign_mem_ip = #{param3}, sign_mem_state = 1 WHERE sign_idx = #{param1} AND emp_id = #{param2}
	</update>
	
	<update id="signStateUpdate">
		UPDATE sign
				<if test="sign_order == '1'.toString()">set sign_state_idx = 1</if>
				<if test="last_order_id == loginId">set sign_state_idx = 2</if>
		WHERE sign_idx = #{param1}
	</update>
	
	<update id="signStateUpdate_first">
		UPDATE sign set sign_state_idx = 2 WHERE sign_idx = #{param1}
	</update>
	
	<select id="signDoMemCnt" resultType="signMemDTO">
		SELECT sm.emp_id, sm.sign_mem_comment, e.emp_name FROM sign_mem sm, employee e WHERE e.emp_id = sm.emp_id AND sign_idx = #{param1} AND sign_mem_state = 1
	</select>
	
	<select id="signImgUpdate" resultType="String">
		SELECT file_new FROM file f, sign s, sign_mem sm WHERE s.sign_idx = #{param1} AND sm.sign_mem_state = 1 AND s.sign_idx = sm.sign_idx AND f.file_sort_idx = 0 AND sm.emp_id = f.file_from
	</select>
	
	<select id="download" resultType="String">
		SELECT file_ori FROM file WHERE file_new = #{param1}
	</select>
	
	<update id="signReturn">
		UPDATE sign_mem set sign_mem_comment = #{param1},sign_mem_ip = #{param2},sign_mem_state=2 WHERE emp_id = #{param3} AND sign_idx = #{param4}
	</update>
	
	<update id="signReturnUpdate">
		UPDATE sign set sign_state_idx = 3 WHERE sign_idx = #{param1}
	</update>
	
	<select id="notiSignNext" resultType="String">
		SELECT emp_id FROM sign_mem sm
			WHERE sign_mem_order = (SELECT max(sign_mem_order) FROM sign_mem sm3 WHERE sign_mem_state = 1 AND sign_idx = #{param1})+1 
			AND sign_idx =#{param1};
   </select>

</mapper>